<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å amoCRM</title>
    <style>
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { border: 1px solid #ddd; padding: 10px; }
        .card { cursor: pointer; }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .status-circle { width: 15px; height: 15px; border-radius: 50%; }
    </style>
</head>
<body>
    <h1>–°–¥–µ–ª–∫–∏ –≤ amoCRM</h1>
    <button onclick="auth()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
    <table class="table">
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ë—é–¥–∂–µ—Ç</th>
                <th>ID</th>
            </tr>
        </thead>
        <tbody id="deals"></tbody>
    </table>

    <script>
        let ACCESS_TOKEN = null;

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        function auth() {
            const clientId = '–í–ê–®_CLIENT_ID';
            const redirectUri = encodeURIComponent(window.location.origin + '/callback.html');
            const authUrl = `https://–í–ê–®_–î–û–ú–ï–ù.amocrm.ru/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}`;
            window.open(authUrl, 'authWindow', 'width=600,height=800');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫
        async function fetchDeals() {
            const res = await fetch('/api/proxy?path=/api/v4/leads', {
                headers: { Authorization: `Bearer ${ACCESS_TOKEN}` }
            });
            const data = await res.json();
            return data._embedded.leads;
        }

        // –†–µ–Ω–¥–µ—Ä —Å–¥–µ–ª–æ–∫
        async function renderDeals() {
            const deals = await fetchDeals();
            const tbody = document.getElementById('deals');
            
            let counter = 0;
            const processChunk = async () => {
                const chunk = deals.splice(0, 3);
                chunk.forEach(deal => {
                    tbody.innerHTML += `
                        <tr class="card" onclick="showDetails(${deal.id})">
                            <td>${deal.name}</td>
                            <td>${deal.price || 0} —Ä—É–±.</td>
                            <td>${deal.id}</td>
                        </tr>
                    `;
                });
                counter++;
                if (deals.length > 0) setTimeout(processChunk, 1000);
            };
            
            processChunk();
        }

        // –î–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏
        async function showDetails(dealId) {
            const res = await fetch(`/api/proxy?path=/api/v4/leads/${dealId}`, {
                headers: { Authorization: `Bearer ${ACCESS_TOKEN}` }
            });
            const deal = await res.json();
            
            const statusColor = getStatusColor(deal.closest_task_at);
            alert(`
                –ù–∞–∑–≤–∞–Ω–∏–µ: ${deal.name}\n
                ID: ${deal.id}\n
                –î–∞—Ç–∞: ${new Date(deal.created_at).toLocaleDateString('ru-RU')}\n
                –°—Ç–∞—Ç—É—Å: ${statusColor}
            `);
        }

        // –¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
        function getStatusColor(taskDate) {
            if (!taskDate) return 'üî¥ –ù–µ—Ç –∑–∞–¥–∞—á–∏';
            const today = new Date();
            const diff = (new Date(taskDate) - today) / (1000 * 3600 * 24);
            return diff < 0 ? 'üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' : diff === 0 ? 'üü¢ –°–µ–≥–æ–¥–Ω—è' : 'üü° –ü–æ–∑–∂–µ';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç callback.html
        window.addEventListener('message', async (e) => {
            if (e.data.type === 'amo_auth_code') {
                const code = e.data.code;
                const res = await fetch(`/api/proxy?path=/oauth2/access_token`, {
                    method: 'POST',
                    body: JSON.stringify({
                        client_id: '–í–ê–®_CLIENT_ID',
                        client_secret: '–í–ê–®_CLIENT_SECRET',
                        grant_type: 'authorization_code',
                        code,
                        redirect_uri: window.location.origin + '/callback.html'
                    })
                });
                const data = await res.json();
                ACCESS_TOKEN = data.access_token;
                renderDeals();
            }
        });
    </script>
</body>
</html>